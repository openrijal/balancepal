---
import AppLayout from '@/layouts/AppLayout.astro';
import GroupHeader from '@/components/groups/GroupHeader.vue';
import { GroupService } from '@/services/groups';
import { ExpenseService } from '@/services/expenses';
import ExpensesContainer from '@/components/expenses/ExpensesContainer.vue';
import GroupSidebar from '@/components/groups/GroupSidebar.vue';
import GroupActivity from '@/components/groups/GroupActivity.vue';

const { id } = Astro.params;

const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

if (!id || !uuidRegex.test(id)) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found',
  });
}

// User is attached by middleware (already authenticated by middleware)
const user = Astro.locals.user!;

const group = await GroupService.getGroupDetails(id);

if (!group) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found',
  });
}

// Check if user is a member of this group
const isMember = group.members.some((m) => m.user.id === user.id);
if (!isMember) {
  return Astro.redirect('/groups'); // Or show access denied
}

const rawExpenses = await ExpenseService.getGroupExpenses(group.id);

// Serialize dates for Vue component
const expenses = rawExpenses.map((exp) => ({
  ...exp,
  date: exp.date.toISOString(),
  updatedAt: exp.updatedAt?.toISOString(),
  createdAt: exp.createdAt?.toISOString(),
}));
---

<AppLayout title={group.name}>
  <div class="container mx-auto px-4 py-8">
    <GroupHeader
      client:load
      groupId={group.id}
      groupName={group.name}
      description={group.description}
      members={group.members}
      currentUserId={user.id}
    />

    <div class="grid gap-6 md:grid-cols-3">
      <!-- Main Content (Expenses List) -->
      <div class="space-y-4 md:col-span-2">
        <ExpensesContainer
          client:load
          groupId={group.id}
          initialExpenses={expenses}
          memberCount={group.members.length}
          members={group.members.map((m) => ({
            id: m.user.id,
            name: m.user.name,
            profilePictureUrl: m.user.profilePictureUrl,
          }))}
          currentUserId={user.id}
        />
      </div>

      <!-- Sidebar (Members & Balances) -->
      <div class="space-y-6">
        <GroupSidebar client:load groupId={group.id} currentUserId={user.id} />
        <GroupActivity client:load groupId={group.id} currentUserId={user.id} />
      </div>
    </div>
  </div>
</AppLayout>
